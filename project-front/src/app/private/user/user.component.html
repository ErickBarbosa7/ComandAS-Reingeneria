<form [formGroup]="formulario" (ngSubmit)="save()" class="user-form">
    
    <!-- ENCABEZADO -->
    <div class="header">
        <h2>{{ isEditMode ? 'Editar Perfil' : 'Nuevo Usuario' }}</h2>
        <p class="subtitle">
            {{ isEditMode ? 'Actualiza la información del sistema' : 'Completa el formulario para registrar un nuevo usuario' }}
        </p>
    </div>

    <div class="fields-container">
        
        <!-- CAMPO: NOMBRE -->
        <mat-form-field appearance="outline" class="w-100">
            <mat-label>Nombre Completo</mat-label>
            <mat-icon matPrefix>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 26 26"><path fill="currentColor" d="M16.563 15.9c-.159-.052-1.164-.505-.536-2.414h-.009c1.637-1.686 2.888-4.399 2.888-7.07c0-4.107-2.731-6.26-5.905-6.26c-3.176 0-5.892 2.152-5.892 6.26c0 2.682 1.244 5.406 2.891 7.088c.642 1.684-.506 2.309-.746 2.397c-3.324 1.202-7.224 3.393-7.224 5.556v.811c0 2.947 5.714 3.617 11.002 3.617c5.296 0 10.938-.67 10.938-3.617v-.811c0-2.228-3.919-4.402-7.407-5.557"/></svg>
            </mat-icon>
            <input type="text" matInput formControlName="name" placeholder="Ej. Juan Pérez">
            <mat-error>El nombre es obligatorio</mat-error>
        </mat-form-field>

        <!-- CAMPO: ROL (Oculto si es el propio cliente editándose) -->
        @if (!isClient) {
            <mat-form-field appearance="outline" class="w-100">
                <mat-label>Asignar Rol</mat-label>
                <mat-icon matPrefix>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Zm6-10.125a1.875 1.875 0 1 1-3.75 0 1.875 1.875 0 0 1 3.75 0Zm1.294 6.336a6.721 6.721 0 0 1-3.17.789 6.721 6.721 0 0 1-3.168-.789 3.376 3.376 0 0 1 6.338 0Z" />
                    </svg>
                </mat-icon>
                <mat-select formControlName="rol">
                    @for (rol of roles; track rol.value) {
                        <mat-option [value]="rol.value">{{rol.name}}</mat-option>
                    }
                </mat-select>
                <mat-error>Debes seleccionar un rol</mat-error>
            </mat-form-field>
        }

        <!-- CAMPO: EMAIL (Solo visible si el rol seleccionado es Cliente - 3) -->
        @if (showEmail) {
            <mat-form-field appearance="outline" class="w-100">
                <mat-label>Correo Electrónico</mat-label>
                <mat-icon matPrefix>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                    </svg>
                </mat-icon>
                
                <!-- readonly si es edición para evitar cambiar el email (identificador) -->
                <input matInput formControlName="email" type="email" [readonly]="isEditMode">
                
                <mat-icon matSuffix>
                    @if (isEditMode) {
                        <!-- Candado: No editable -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg>
                    } @else {
                        <!-- Icono normal -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>
                    }
                </mat-icon>
            </mat-form-field>
        }

        <!-- CAMPO: CONTRASEÑA -->
        <mat-form-field appearance="outline" class="w-100">
            <mat-label>{{ isEditMode ? 'Nueva Contraseña (Opcional)' : 'Contraseña' }}</mat-label>
            <mat-icon matPrefix>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                </svg>
            </mat-icon>
            <input type="password" matInput formControlName="password" 
                   [placeholder]="isEditMode ? 'Dejar vacío para no cambiar' : 'Asigna una contraseña'">
            
            @if (!isEditMode && formulario.get('password')?.invalid && formulario.get('password')?.touched) {
                <mat-error>La contraseña es requerida</mat-error>
            }
        </mat-form-field>

        <!-- CAMPO: TELÉFONO -->
        <mat-form-field appearance="outline" class="w-100">
            <mat-label>Teléfono</mat-label>
            <mat-icon matPrefix>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
                </svg>
            </mat-icon>
            <input type="text" matInput formControlName="phone" placeholder="10 dígitos">
        </mat-form-field>

    </div>
   
    <!-- BOTONES -->
    <div class="actions">
        <!-- Botón Eliminar: Solo en edición y si NO es el cliente mismo -->
        @if (isEditMode && !isClient) {
            <button type="button" class="button-secundary" (click)="deleteUser()">
                Eliminar Usuario
            </button>
        } @else {
            <div class="spacer"></div> 
        }
        
        <button type="submit" class="button-primary" [disabled]="formulario.invalid">
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Usuario' }}
        </button>
    </div>

</form>